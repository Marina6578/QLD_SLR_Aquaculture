---
title: "ImpactSLR_Erosion_over_aquaculture"
output: html_document
date: "2023-08-11"
---

`
#load packages I will need
```{r}
library(tidyverse)
library(here)
library(tmap)
library(sf)
library(ggplot2)
library(dplyr)
```

# load data
#Queensland leases data obtained from DAF and then ground truthed in the seascapes Lab

```{r}
qld_leases<-st_read(here("raw_data/QLD_aqua_ground_truth/QLD_terr_aquaculture_ground_truth.shp"))
```
#reproject data of the queensland aquaculture leases and create a new column with the area of the polygons

```{r}
qld_leases_reproj<-st_transform(qld_leases, 3577)
qld_leases_reproj <- qld_leases_reproj %>%
  mutate(lease_area_m2 = st_area(.))

```

#load australia map
```{r}
Australia_map<- st_read(here("raw_data/Australia_country_SHP/AUS_2021_AUST_GDA2020.shp"))
```

#load data 
#Queensland state map

```{r}
Qld_map<-st_read(here("raw_data/AustralianStates_SHP/STE_2021_AUST_GDA2020.shp"))
```

#load data 
#Queensland erosion all components erosion and sLR obtained http://qldspatial.information.qld.gov.au/catalogue/custom/search.page?q=%22Erosion prone area all components%22


```{r}
QLD_coastal_erosion_all<-st_read(here("raw_data/QSC_all_components_of_SLR/Erosion_prone_area_all_components.shp"))
```

# reproject all data previously uploaded in shapefile (to 3577 -Australian Albers)

```{r}
Qld_reproj<-st_transform(Qld_map, 3577)

Australia_map_reproj<-st_transform(Australia_map, 3577)

QLD_coastal_erosion_reproj<-st_transform(QLD_coastal_erosion_all, 3577)
```

# Dissolve coastal erosion all components layer
```{r}
QLD_coastal_erosion_diss<-QLD_coastal_erosion_reproj %>%
  mutate(diss = 1) %>% #create column to dissolve by
  group_by(diss) %>% #group by column you created
  summarise(diss2 = sum(diss, na.rm = T)) #combine column into one new variable

```
#total farms without doubles
```{r}
totalfarms<- qld_leases_reproj%>% 
  group_by(qldglb_)%>%
  summarise(geometry= st_union(geometry))%>%
mutate(area_m2 = st_area(.))

```
#total farms only the ones that were marked as YES in the ground truthing process as aquaculture 
```{r}
totalfarms_yes<- qld_leases_reproj%>% 
  filter(Aqcltr_n == "Y") %>%
  group_by(qldglb_)%>%
  summarise(geometry= st_union(geometry))%>%
mutate(area_m2 = st_area(.))

```
#intersect  aquaculture leases with dissolved coastal erosion  layer

```{r}

qld_leases_erosion<-st_intersection(QLD_coastal_erosion_diss, totalfarms)
#beware that we have changed this for the totalfarms not being repeated before the intersection.if we consider only the yes farms we will have to change it like we did dont here as follows 
```
#only the yes column before intersection (yes that were ground truthed as aquaculture)
```{r}

qld_leases_erosion_yes<-st_intersection(QLD_coastal_erosion_diss, totalfarms_yes)

```
#Create a Column and get the proportion of each lease that might be affected following erosion and SLR in 2100 in QLD
```{r}
qld_leases_erosion <- qld_leases_erosion %>%
  mutate(affected_area_m2 = st_area(.),
         propaffectedArea= affected_area_m2/area_m2)
```
#Create a shapefile of the intersection between the Aquaculture leases in Queensland and erosion prone areas in Queensland to check how many of them would be potetially affected
```{r}
st_write(qld_leases_erosion, here("output_data/qld_leases_erosion_all.shp"), delete_layer = TRUE)
```
#create a shapefile of the qld_leases_reproj to group them by "farm" or User
```{r}
st_write(qld_leases_reproj, here("output_data/qld_leases_reproj.shp"), delete_layer = TRUE)
```
#open the created shapefile in R to further dissolve by farm ID qldgbl_
```{r}
qld_leases_to_group<-st_read(here("output_data/qld_leases_reproj.shp"))
```
#dissolving by farm ID (grouped) or without doubles

```{r}
totalfarmsaffected<- qld_leases_erosion%>% 
  group_by(qldglb_)%>%
  summarise(geometry= st_union(geometry))
```
#not sure this is right because from the leases we have received they were 279 (started doing polygons for extra farms but maybe best to do before ground truth to see whats the results only with DAFs leases and do it again for "new" not leases areas?

